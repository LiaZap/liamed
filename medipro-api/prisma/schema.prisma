generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Clinic {
  id        String      @id @default(uuid())
  name      String
  cnpj      String?     @unique
  address   String?
  phone     String?
  email     String?
  logo      String?
  status    Status      @default(ATIVO)
  createdAt DateTime    @default(now())
  consults  Consult[]
  diagnoses Diagnosis[]
  users     User[]

  @@map("clinics")
}

model User {
  id                  String               @id @default(uuid())
  name                String
  email               String               @unique
  password            String
  phone               String?
  address             String?
  biography           String?
  role                Role                 @default(MEDICO)
  status              Status               @default(ATIVO)
  endpointId          String?
  customPrompt        String?
  createdAt           DateTime             @default(now())
  lastLogin           DateTime?
  clinicId            String?
  specialty           String?
  notifyVagasWhatsApp Boolean              @default(false)
  notifyVagasEmail    Boolean              @default(false)
  termsAcceptedAt     DateTime?
  auditLogs           AuditLog[]
  calculationHistory  CalculationHistory[]
  consults            Consult[]
  diagnoses           Diagnosis[]
  notifications       Notification[]
  subscriptions       Subscription[]
  clinic              Clinic?              @relation(fields: [clinicId], references: [id])
  endpoint            Endpoint?            @relation(fields: [endpointId], references: [id])

  @@index([clinicId])
  @@map("users")
}

model Consult {
  id          String        @id @default(uuid())
  patientName String
  doctorId    String
  doctorName  String
  date        DateTime
  type        ConsultType   @default(CONSULTA)
  status      ConsultStatus @default(AGENDADA)
  createdAt   DateTime      @default(now())
  clinicId    String?
  clinic      Clinic?       @relation(fields: [clinicId], references: [id])
  doctor      User          @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  diagnosis   Diagnosis?

  @@index([doctorId])
  @@index([clinicId])
  @@index([date])
  @@index([status])
  @@map("consults")
}

model Diagnosis {
  id                String          @id @default(uuid())
  consultId         String?         @unique
  doctorId          String
  patientName       String
  userPrompt        String
  aiResponse        String
  model             String          @default("gpt-4")
  status            DiagnosisStatus @default(ORIGINAL)
  metadata          Json?
  createdAt         DateTime        @default(now())
  complementaryData String?
  exams             Json?
  clinicId          String?
  clinic            Clinic?         @relation(fields: [clinicId], references: [id])
  consult           Consult?        @relation(fields: [consultId], references: [id])
  doctor            User            @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([clinicId])
  @@index([patientName])
  @@index([createdAt])
  @@map("diagnoses")
}

model Endpoint {
  id          String     @id @default(uuid())
  name        String
  url         String
  method      HttpMethod @default(POST)
  authType    AuthType   @default(BASIC_AUTH)
  credentials Json
  status      Status     @default(ATIVO)
  createdAt   DateTime   @default(now())
  users       User[]

  @@map("endpoints")
}

model Setting {
  id          String          @id @default(uuid())
  key         String          @unique
  value       String
  type        SettingType
  category    SettingCategory
  required    Boolean         @default(false)
  description String

  @@index([category])
  @@map("settings")
}

model Prompt {
  id       String         @id @default(uuid())
  name     String
  category PromptCategory
  content  String
  isActive Boolean        @default(true)

  @@index([category])
  @@index([isActive])
  @@map("prompts")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  userName   String
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resource])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Plan {
  id            String         @id @default(uuid())
  name          String
  description   String?
  price         Decimal        @db.Decimal(10, 2)
  interval      PlanInterval
  features      Json?
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String
  planId               String
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  stripeSubscriptionId String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  invoices             Invoice[]
  plan                 Plan               @relation(fields: [planId], references: [id])
  user                 User               @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

model Invoice {
  id              String        @id @default(uuid())
  subscriptionId  String
  amount          Decimal       @db.Decimal(10, 2)
  status          InvoiceStatus @default(OPEN)
  dueDate         DateTime
  paidAt          DateTime?
  stripeInvoiceId String?
  pdfUrl          String?
  createdAt       DateTime      @default(now())
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id])
  payments        Payment[]

  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

model Payment {
  id            String        @id @default(uuid())
  invoiceId     String
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?
  metadata      Json?
  createdAt     DateTime      @default(now())
  invoice       Invoice       @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@index([status])
  @@map("payments")
}

model CalculatorFormula {
  id          String               @id @default(uuid())
  name        String
  description String?
  expression  String
  category    String
  reference   String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  history     CalculationHistory[]
  variables   CalculatorVariable[]

  @@map("calculator_formulas")
}

model CalculatorVariable {
  id           String            @id @default(uuid())
  formulaId    String
  name         String
  label        String
  type         VariableType      @default(NUMBER)
  unit         String?
  defaultValue String?
  options      Json?
  min          Float?
  max          Float?
  step         Float?
  formula      CalculatorFormula @relation(fields: [formulaId], references: [id], onDelete: Cascade)

  @@index([formulaId])
  @@map("calculator_variables")
}

model CalculationHistory {
  id          String            @id @default(uuid())
  userId      String
  formulaId   String
  patientName String?
  inputs      Json
  result      Float
  createdAt   DateTime          @default(now())
  formula     CalculatorFormula @relation(fields: [formulaId], references: [id])
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([formulaId])
  @@map("calculation_history")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@map("password_reset_tokens")
}

enum Role {
  ADMIN
  MEDICO
  GESTOR
}

enum Status {
  ATIVO
  INATIVO
}

enum ConsultType {
  CONSULTA
  RETORNO
  EMERGENCIA
}

enum ConsultStatus {
  AGENDADA
  CONCLUIDA
  CANCELADA
}

enum DiagnosisStatus {
  ORIGINAL
  EDITADO
}

enum HttpMethod {
  GET
  POST
  PUT
  DELETE
  PATCH
}

enum AuthType {
  BASIC_AUTH
  BEARER
  API_KEY
  OAUTH2
  JWT
  DIGEST_AUTH
  NTLM
  AWS_SIGNATURE
  CUSTOM_HEADER
  NONE
}

enum SettingType {
  BOOLEAN
  STRING
  NUMBER
}

enum SettingCategory {
  GERAL
  SEGURANCA
  EMAIL
  NOTIFICACOES
  SISTEMA
}

enum PromptCategory {
  DIAGNOSTICO
  TRATAMENTO
  EVOLUCAO
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum PlanInterval {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  TRIALING
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  UNCOLLECTIBLE
  VOID
}

enum PaymentMethod {
  CREDIT_CARD
  BOLETO
  PIX
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum VariableType {
  NUMBER
  SELECT
  BOOLEAN
}
